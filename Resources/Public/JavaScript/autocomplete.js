// Generated by CoffeeScript 1.7.1

/*
Autocomplete for select fields
 */
var delay;

$.fn.autocomplete = function() {
  return this.each(function() {
    var $fakeSelect, $filter, $filterContainer, $list, $overlay, $popup, $select, $spinner, isAjax, name, oldVal;
    $select = $(this);
    $select.css({
      opacity: 0
    });
    name = $select.data('type') ? $select.data('type') : $select.attr('name').replace('[]', '');
    isAjax = $select.hasClass('ajax');
    $select.siblings('.autocomplete').remove();
    $fakeSelect = $('<input class="select" type="text">').val($select.find(':selected').text()).attr('title', $select.find(':selected').text());
    $spinner = $('<i class="spinner spinner-icon"/>');
    $filter = $('<input type="text" placeholder="Filter">');
    $filterContainer = $('<div class="filter"/>').append($filter);
    $list = $('<ol class="list"/>');
    $popup = $('<div class="popup"/>').append($filterContainer, $list);
    $popup.css({
      top: $('select:eq(0)').outerHeight()
    });
    $overlay = $('<div class="overlay autocomplete"/>').append($fakeSelect, $spinner, $popup);
    $overlay.insertAfter($select);
    if (!$select.hasClass('ajax')) {
      $.each($select.find('option'), function(index, element) {
        return $list.append("<li data-uuid='" + ($(element).val()) + "'>" + ($(element).text()) + "</li>");
      });
    }
    $fakeSelect.focus(function() {
      $fakeSelect.blur();
      $list.find('li').show().first().addClass('current');
      $popup.slideDown();
      return $filter.focus();
    });
    $list.on('click', 'li', function() {
      if (isAjax) {
        $select.empty().append("<option value='" + ($(this).data('uuid')) + "' selected>" + ($(this).text()) + "</option>");
      } else {
        $select.val($(this).data('uuid'));
      }
      $fakeSelect.val($(this).text()).attr('title', $select.find(':selected').text());
      $select.trigger('change');
      return $(document).click();
    });
    oldVal = '';
    $filter.on('keydown', function(e) {
      var $current, $newCurrent, $visibleItems;
      if (isAjax) {
        if ($filter.val().length > 0 && $filter.val() !== oldVal) {
          oldVal = $filter.val();
          delay((function() {
            $spinner.show();
            return $.ajax({
              url: "/search" + (ucfirst(name)) + "?searchString=" + (encodeURIComponent($filter.val())),
              type: 'GET',
              complete: function() {
                return $spinner.hide();
              },
              error: function() {
                return alert('Fehler: Daten konnten nicht geladen werden.');
              },
              success: function(data) {
                var json;
                json = $.parseJSON(data);
                $list.empty();
                $.each(json, function(index, item) {
                  return $list.append("<li data-uuid='" + item.uUID + "'>" + item.name + "</li>");
                });
                return $list.slideDown().scrollTop(0).find('li').first().addClass('current');
              }
            });
          }), 500);
        }
      } else {
        $.each($list.find('li'), function(index, item) {
          if ($(item).text().toLowerCase().indexOf($filter.val().toLowerCase()) > -1) {
            return $(item).show();
          } else {
            return $(item).hide();
          }
        });
      }
      if ($list.is(':visible')) {
        $visibleItems = $list.children(':visible');
        $visibleItems.filter('.current:gt(0)').removeClass('current');
        $current = $visibleItems.filter('.current');
        if (!$current.length) {
          $current = $visibleItems.first().addClass('current');
        }
        switch (e.which) {
          case 13:
            e.preventDefault();
            $current.click();
            return false;
          case 38:
            $newCurrent = $current.prevAll(':visible').first();
            if (!$newCurrent.length) {
              $newCurrent = $visibleItems.last();
            }
            $current.removeClass('current');
            $newCurrent.addClass('current');
            $list.scrollTop($newCurrent.offset().top - $list.offset().top + $list.scrollTop() - $list.height() / 3);
            return false;
          case 9:
          case 40:
            $newCurrent = $current.nextAll(':visible').first();
            if (!$newCurrent.length) {
              $newCurrent = $visibleItems.first();
            }
            $current.removeClass('current');
            $newCurrent.addClass('current');
            $list.scrollTop($newCurrent.offset().top - $list.offset().top + $list.scrollTop() - $list.height() / 3);
            return false;
          case 35:
          case 36:
          case 27:
            return $(document).click();
        }
      }
    });
    $(document).click(function() {
      $popup.slideUp();
      $list.find('.current').removeClass('current');
      return $filter.val('');
    });
    return $overlay.click(function(e) {
      return false;
    });
  });
};

delay = (function() {
  var timer;
  timer = 0;
  return function(callback, ms) {
    clearTimeout(timer);
    return timer = setTimeout(callback, ms);
  };
})();
