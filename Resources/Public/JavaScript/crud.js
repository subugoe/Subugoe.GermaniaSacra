// Generated by CoffeeScript 1.7.1
$.fn.update_list = function(url) {
  return $.post(url, $("#UpdateList").serialize()).done(function(respond, status, jqXHR) {
    if (status === "success") {
      $("#confirm").modal({
        closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
        position: ["20%"],
        overlayId: "confirm-overlay",
        containerId: "confirm-container",
        onShow: function(dialog) {
          return $(".message").append("Der Eintrag wurde erfolgreich bearbeitet.");
        }
      });
      return setTimeout((function() {
        return window.location.href = "";
      }), 1000);
    }
  }).fail(function(jqXHR, textStatus) {
    return $("#confirm").modal({
      closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
      position: ["20%"],
      overlayId: "confirm-overlay",
      containerId: "confirm-container",
      onShow: function(dialog) {
        return $(".message").append(jqXHR.responseText);
      }
    });
  });
};

$.fn.populate_liste = function(page) {
  var $this;
  $this = $(this);
  return $.getJSON("klosterListAll", function(response) {
    var $inputBearbeitungsstatus, $trTemplate, bearbeitungsstatusArray, klosters, table;
    bearbeitungsstatusArray = response[1];
    $inputBearbeitungsstatus = $("select[name='bearbeitungsstatus']");
    $inputBearbeitungsstatus.empty();
    $.each(bearbeitungsstatusArray, function(k, v) {
      return $.each(v, function(k1, v1) {
        return $inputBearbeitungsstatus.append($("<option>", {
          value: v1,
          html: k1
        }));
      });
    });
    klosters = response[0];
    $trTemplate = $("#list tbody tr:first");
    $("#list thead th").not(":first").not(":last").each(function() {
      return $(this).append("<div><input type=\"text\"></div>");
    });
    table = $("#list").DataTable({
      autoWidth: false,
      columnDefs: [
        {
          bSortable: false,
          aTargets: ["no-sorting"]
        }, {
          width: "10%",
          targets: 1
        }
      ],
      dom: "lipt",
      language: {
        url: "/_Resources/Static/Packages/Subugoe.GermaniaSacra/JavaScript/DataTables/German.json"
      },
      order: [[3, "asc"]],
      fnDrawCallback: function() {
        $("#list textarea").autosize();
        return $("#list :input:not(:checkbox)").change(function() {
          return $(this).closest("td").addClass("dirty").closest("tr").find(":checkbox:eq(0)").prop("checked", true);
        });
      }
    });
    table.columns().eq(0).each(function(colIdx) {
      return $("input", table.column(colIdx).header()).click(function(e) {
        return e.stopPropagation();
      }).on("keyup change", function() {
        return table.column(colIdx).search(this.value).draw();
      });
    });
    $("body").append("<input id=\"uuidFilter\" type=\"hidden\">");
    $("#uuidFilter").change(function() {
      return table.column(0).search(this.value, true, false).draw();
    });
    $.each(klosters, function(index, kloster) {
      var $tr;
      $tr = $trTemplate.clone(true);
      $tr.find(":input").each(function() {
        var name, val;
        name = $(this).attr("name");
        if (typeof name === "undefined") {
          return;
        }
        val = kloster[name];
        if ($(this).is("[type=checkbox]")) {
          if (name === "auswahl") {
            $(this).val(kloster.uuid);
          }
        } else if ($(this).is("select")) {
          if (name === "bearbeitungsstatus") {
            $tr.find("select[name=bearbeitungsstatus] option").each(function(i, opt) {
              if (opt.value === val) {
                return $(opt).attr("selected", "selected");
              }
            });
          } else {
            $(this).append("<option>" + val + "</option>");
          }
        } else {
          if (name !== "__csrfToken") {
            $(this).val(val);
          }
        }
        if (name !== "__csrfToken" && name !== "auswahl") {
          $(this).attr("name", name + "[" + kloster.uuid + "]");
          return $("<span class=\"val\"/>").text(($(this).is("select") ? $(this).find(":selected").text() : $(this).val())).hide().insertBefore($(this));
        }
      });
      $tr.find(".edit").attr("href", "edit/" + kloster.uuid);
      $tr.find(".delete").attr("href", "delete/" + kloster.uuid);
      $tr.find("input.csrf").attr("id", "csrf" + index);
      return table.row.add($tr);
    });
    return table.row($trTemplate).remove().draw();
  });
};

$.fn.populate_selects = function() {
  var url;
  url = "getOptions";
  return $.getJSON(url, function(response) {
    var options;
    options = {};
    options.bearbeitungsstatus = response[0];
    options.personallistenstatus = response[1];
    options.band = response[2];
    options.literatur = response[3];
    options.bistum = response[4];
    options.orden = response[5];
    options.klosterstatus = response[6];
    options.bearbeiter = response[7];
    return $.each(options, function(name, values) {
      var $select;
      $select = $("select[name=\"" + name + "\"], select[name=\"" + name + "[]\"]");
      $select.empty().append($("<option>", {
        value: "",
        text: ""
      }));
      return $.each(values, function(index, object) {
        return $.each(object, function(value, uuid) {
          return $select.append($("<option>", {
            value: uuid,
            text: value
          }));
        });
      });
    });
  });
};

$.fn.new_kloster = function() {
  $("#edit").clear_form();
  $("#browse").slideUp();
  $("#edit").slideDown();
  $("#edit .autocomplete").autocomplete();
  $("#edit textarea").trigger("autosize.resize");
  return $("#edit input[type=url]").keyup();
};

$.fn.populate_kloster = function(url) {
  var $this;
  $this = $(this);
  $("#edit").clear_form();
  return $.getJSON(url, function(kloster) {
    var $fieldset, update_url, uuid;
    uuid = kloster.uuid;
    update_url = "update/" + uuid;
    $("#EditKloster").attr("action", update_url);
    $fieldset = $("#kloster");
    $fieldset.find("label :input").each(function() {
      var name, val;
      name = $(this).attr("name");
      if (typeof name === "undefined") {
        return name = name.replace("[]", "");
      }
      val = kloster[name];
      return $(this).val(val);
    });
    $fieldset.find(".bearbeiter").text(kloster.bearbeiter || "?");
    $fieldset.find(".changeddate").text((kloster.changeddate ? kloster.changeddate.date.substr(0, kloster.changeddate.date.indexOf(".")) : "?"));
    $fieldset = $("#klosterorden");
    $.each(kloster.klosterorden, function(index, value) {
      if (index > 0) {
        $fieldset.find(".multiple:last()").addInputs(0);
      }
      return $fieldset.find(".multiple:last() label :input").each(function() {
        var name;
        name = $(this).attr("name");
        if (typeof name === "undefined") {
          return;
        }
        name = name.replace("[]", "");
        return $(this).val(value[name]);
      });
    });
    $fieldset = $("#klosterstandorte");
    $.each(kloster.klosterstandorte, function(index, value) {
      if (index > 0) {
        $fieldset.find(".multiple:last()").addInputs(0);
      }
      return $fieldset.find(".multiple:last() label :input").each(function() {
        var name, val;
        name = $(this).attr("name");
        if (typeof name === "undefined") {
          return;
        }
        name = name.replace("[]", "");
        val = value[name];
        if (name === "wuestung") {
          if (name === "wuestung") {
            return $(this).prop("checked", value[name] === 1);
          }
        } else if (name === "ort") {
          return $(this).html($("<option />", {
            value: value["uuid"],
            text: value["ort"]
          }).attr("selected", true));
        } else if (name === "bistum") {
          return $(this).val(value[name]).prop("disabled", typeof value[name] !== "undefined");
        } else {
          return $(this).val(value[name]);
        }
      });
    });
    $fieldset = $("#links");
    $.each(kloster.url, function(index, value) {
      if (value.url_typ === "GND") {
        return $("#gnd").val(value.url);
      } else if (value.url_typ === "Wikipedia") {
        return $("#wikipedia").val(value.url);
      } else {
        $fieldset.find(".multiple:last()").addInputs(0);
        return $fieldset.find(".multiple:last() label :input").each(function() {
          var name;
          name = $(this).attr("name");
          if (typeof name === "undefined") {
            return;
          }
          name = name.replace("[]", "");
          return $(this).val(value[name]);
        });
      }
    });
    $fieldset.find(".multiple:eq(0)").removeInputs(0);
    $fieldset = $("#literatur");
    $.each(kloster.literatur, function(index, value) {
      if (index > 0) {
        $fieldset.addInputs(0);
      }
      return $fieldset.find(".multiple:last() label :input").each(function() {
        var name;
        name = $(this).attr("name");
        if (typeof name === "undefined") {
          return;
        }
        name = name.replace("[]", "");
        return $(this).val(value);
      });
    });
    $("#browse").slideUp();
    $("#edit").slideDown();
    $("#edit .autocomplete").autocomplete();
    $("#edit textarea").trigger("autosize.resize");
    return $("#edit input[type=url]").keyup();
  });
};

$.fn.update_kloster = function(url) {
  return $.post(url, $("#EditKloster").serialize()).done(function(respond, status, jqXHR) {
    if (status === "success") {
      return $("#confirm").modal({
        closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
        position: ["20%"],
        overlayId: "confirm-overlay",
        containerId: "confirm-container",
        onShow: function(dialog) {
          return $(".message").append("Der Eintrag wurde erfolgreich bearbeitet.");
        }
      });
    }
  }).fail(function(jqXHR, textStatus) {
    return $("#confirm").modal({
      closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
      position: ["20%"],
      overlayId: "confirm-overlay",
      containerId: "confirm-container",
      onShow: function(dialog) {
        return $(".message").append(jqXHR.responseText);
      }
    });
  });
};

$.fn.create_kloster = function() {
  return $.post("create", $("#EditKloster").serialize()).done(function(respond, status, jqXHR) {
    var addKlosterId_url, dataArray, uuid;
    if (status === "success") {
      dataArray = $.parseJSON(respond);
      uuid = dataArray[0];
      addKlosterId_url = "addKlosterId";
      $.get(addKlosterId_url, {
        uuid: uuid
      });
      return $("#confirm").modal({
        closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
        position: ["20%"],
        overlayId: "confirm-overlay",
        containerId: "confirm-container",
        onShow: function(dialog) {
          return $(".message").append("Der Eintrag wurde erfolgreich gespeichert.");
        }
      });
    }
  }).fail(function(jqXHR, textStatus) {
    return $("#confirm").modal({
      closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
      position: ["20%"],
      overlayId: "confirm-overlay",
      containerId: "confirm-container",
      onShow: function(dialog) {
        return $(".message").append(jqXHR.responseText);
      }
    });
  });
};

$.fn.delete_kloster = function(url, csrf) {
  var check;
  check = confirm("Wollen Sie diesen Eintrag wirklich löschen?");
  if (check === true) {
    return $.post(url, {
      __csrfToken: csrf
    }).done(function(respond, status, jqXHR) {
      if (status === "success") {
        $("#confirm").modal({
          closeHTML: "<a href='#' title='Close' class='modal-close'>x</a>",
          position: ["20%"],
          overlayId: "confirm-overlay",
          containerId: "confirm-container",
          onShow: function(dialog) {
            return $(".message").append("Der Eintrag wurde erfolgreich gelöscht.");
          }
        });
        return setTimeout((function() {
          return window.location.href = "";
        }), 1000);
      }
    }).fail(function(jqXHR, textStatus) {
      return alert(jqXHR.responseText);
    });
  }
};

$.fn.clear_form = function() {
  $(this).find(":input").prop("disabled", false);
  $(this).find(":input:not(:checkbox):not([type=hidden]):not(:submit)").val("");
  $(this).find(":checkbox, :radio").prop("checked", false);
  $(this).find(".multiple:gt(0)").removeInputs(0);
  return $(this).find(".autofill").text("?");
};
