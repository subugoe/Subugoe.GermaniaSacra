// Generated by CoffeeScript 1.7.1
germaniaSacra.controller('listController', function($scope) {
  $scope.$watch((function() {
    return $('#list').data('type');
  }), (function(newval, oldval) {
    var type;
    if (newval != null) {
      type = $('#list').data('type');
      $('#message, #search, #list').hide();
      $('.togglable + .togglable').hide();
      germaniaSacra.search = new germaniaSacra.Search();
      germaniaSacra.editor = new germaniaSacra.Editor(type);
      return $.when(germaniaSacra.getOptions()).then(function(selectOptions) {
        germaniaSacra.selectOptions = selectOptions;
        germaniaSacra.list = new germaniaSacra.List(type);
        $('.toggle').click(function(e) {
          e.preventDefault();
          return $(this).closest('.togglable').siblings('.togglable').addBack().slideToggle();
        });
        germaniaSacra.bindKeys();
        $('#edit form, #list form').appendSaveButton();
        return $('fieldset .multiple').appendAddRemoveButtons();
      }, function() {
        return germaniaSacra.message('Fehler: Optionen k√∂nnen nicht geladen werden');
      });
    }
  }), true);
  return $scope.$on('$locationChangeStart', function(e) {
    if ($('.dirty').length) {
      if (confirm(germaniaSacra.messages.askUnsavedChanges)) {
        return $('.dirty').removeClass('dirty');
      } else {
        return e.preventDefault();
      }
    }
  });
});

germaniaSacra.getOptions = function() {
  var dfd;
  dfd = $.Deferred();
  $.getJSON('getOptions', function(response) {
    $.each(response, function(name, values) {
      var $selects;
      $selects = $("#edit select[name='" + name + "'], select[name='" + name + "[]'], select[name='" + name + "_uid']");
      $selects.empty();
      return $.each(values, function(uUID, text) {
        return $selects.append($('<option/>', {
          value: uUID,
          text: text
        }));
      });
    });
    return dfd.resolve(response);
  });
  return dfd.promise();
};

germaniaSacra.bindKeys = function() {
  return $(window).bind('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
      switch (String.fromCharCode(e.which).toLowerCase()) {
        case 'a':
          e.preventDefault();
          return $('button.new:visible:last').click();
        case 's':
          e.preventDefault();
          return $(':submit[type=submit]:visible:last').click();
      }
    }
  });
};

germaniaSacra.message = function(text, withTimestampAndCloseButton) {
  var $close, $message, date, timestamp;
  if (withTimestampAndCloseButton == null) {
    withTimestampAndCloseButton = true;
  }
  $message = $('#message');
  date = new Date();
  timestamp = withTimestampAndCloseButton ? "<span class='timestamp'>" + (date.toLocaleString()) + "</span>" : '';
  text = "<span class='text'>" + text + "</span>";
  $message.hide().html(timestamp + text).show();
  if (withTimestampAndCloseButton) {
    $close = $("<i class='hover close icon-close right'>&times;</i>");
    $close.appendTo($message).click(function(e) {
      e.preventDefault();
      return $message.hide();
    });
  }
  return $('html, body').animate({
    scrollTop: $message.offset().top
  });
};

window.onbeforeunload = function() {
  if ($('.dirty').length) {
    return germaniaSacra.messages.askUnsavedChanges;
  }
};
