// Generated by CoffeeScript 1.7.1
var dataTable, populateListAction, updateListAction;

dataTable = null;

populateListAction = function(type) {
  var $table, $this, $ths, ajaxSuccess, columns, selectOptions;
  $this = $('#' + type);
  if (!$this.length) {
    alert('There has to be a <section> whose id equals type');
    return;
  }
  $this.hide();
  $('#loading').show();
  $table = $this.find("table:eq(0)");
  $table.find("thead th").not(":first").not(":last").each(function() {
    return $(this).append('<div><input type="text"></div>');
  });
  $ths = $table.find('th');
  columns = [];
  $ths.each(function() {
    if ($(this).data('name') != null) {
      return columns.push({
        data: $(this).data('name')
      });
    }
  });
  columns.push({
    "class": 'no-wrap show-only-on-hover',
    data: null,
    defaultContent: $ths.last().data('html')
  });
  selectOptions = {};
  dataTable = $table.DataTable({
    sAjaxSource: '/entity/' + type,
    columns: columns,
    autoWidth: false,
    columnDefs: [
      {
        bSortable: false,
        aTargets: ["not-sortable"]
      }
    ],
    dom: "lipt",
    language: {
      url: "/_Resources/Static/Packages/Subugoe.GermaniaSacra/JavaScript/DataTables/German.json"
    },
    order: [[3, "asc"]],
    fnServerData: function(sSource, aoData, fnCallback, oSettings) {
      return oSettings.jqXHR = $.ajax({
        dataType: 'json',
        type: 'GET',
        url: sSource,
        data: aoData,
        success: [ajaxSuccess, fnCallback]
      });
    },
    fnDrawCallback: function() {
      var $tr;
      $tr = $table.find('tbody tr:not(.processed)');
      $tr.children().each(function() {
        var $input, $th, obj, select_name, _i, _len, _ref;
        $th = $table.find('th[data-name]').eq($(this).index());
        if ($th.length) {
          $input = $('<' + $th.data('input') + '/>').attr({
            name: $th.data('name')
          });
          if ($th.data('input') === 'select') {
            select_name = $th.data('name');
            if (selectOptions[select_name] != null) {
              _ref = selectOptions[select_name];
              for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                obj = _ref[_i];
                $input.append($('<option/>').text(obj.name).attr('value', obj.uuid));
              }
            }
          }
          return $(this).html($input.val($(this).text()));
        }
      });
      $tr.each(function() {
        var uuid;
        uuid = $(this).find(':input[name=uuid]').val();
        $(this).find("textarea").autosize();
        return $(this).find(":input:not(:checkbox)").change(function() {
          return $(this).closest("td").addClass("dirty").closest("tr").find(":checkbox:eq(0)").prop("checked", true);
        });
      });
      return $tr.addClass('processed');
    }
  }, ajaxSuccess = function(json) {
    $this.show();
    $('#loading').hide();
    return selectOptions.bearbeitungsstatus = json.bearbeitungsstatus;
  });
  $table.on("click", ".edit", function(e) {
    e.preventDefault();
    return editAction(type, $(this).closest('tr').find(':input[name=uuid]').val());
  });
  $table.on("click", ".delete", function(e) {
    e.preventDefault();
    return deleteAction(type, $(this).closest('tr').find(':input[name=uuid]').val());
  });
  dataTable.columns().eq(0).each(function(colIdx) {
    return $("input", dataTable.column(colIdx).header()).click(function(e) {
      return e.stopPropagation();
    }).on("keyup change", function() {
      return dataTable.column(colIdx).search(this.value).draw();
    });
  });
  $("body").append('<input id="uuid_filter" type="hidden">');
  $("#uuid_filter").change(function() {
    return dataTable.column(0).search(this.value, true, false).draw();
  });
};

updateListAction = function(type) {
  var $rows, $this, formData;
  $this = $('#' + type);
  $rows = dataTable.$('tr').has('input:checked');
  formData = {};
  $rows.each(function() {
    var uuid;
    uuid = $(this).find(':input[name=uuid]').val();
    formData['klosters[' + uuid + ']'] = {};
    return $(this).find(':input:not([name=uuid])').each(function(i, input) {
      if (input.name) {
        formData['klosters[' + uuid + ']'][input.name] = input.value;
      }
    });
  });
  formData.__csrfToken = $(this).find('input[name=__csrfToken]').val();
  return $.post('updateList', formData).done(function(respond, status, jqXHR) {
    return $.post("updateSolrAfterListUpdate", {
      uuids: respond
    }).done(function(respond, status, jqXHR) {
      if (status === "success") {
        return $this.message('Ihre Ã„nderungen wurden gespeichert.');
      }
    }).fail(function(jqXHR, textStatus) {
      $this.message('Error');
      return console.dir(jqXHR.responseText);
    });
  }).fail(function(jqXHR, textStatus) {
    $this.message('Error');
    return console.dir(jqXHR.responseText);
  });
};
