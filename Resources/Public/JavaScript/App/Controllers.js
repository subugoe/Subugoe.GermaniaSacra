// Generated by CoffeeScript 1.7.1
germaniaSacra.controller('listController', function($scope, $http, DTOptionsBuilder, DTColumnBuilder) {
  var entityName;
  entityName = $('section[ng-controller]').attr('id');
  $scope.childRows = $('.child-row');
  $scope.ths = $('th');
  $scope.entities = {};
  $scope.updated = {};
  $scope.newCount = 0;
  $scope.dtOptions = DTOptionsBuilder.fromSource('/entity/' + entityName).withDOM('lifpt').withLanguage({
    sUrl: '/_Resources/Static/Packages/Subugoe.GermaniaSacra/JavaScript/DataTables/German.json'
  }).withOption('fnDrawCallback', function() {
    var $trs, entity, id, _i, _len, _ref;
    _ref = $scope.dataTables.context[0].aoData;
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      entity = _ref[_i];
      id = entity._aData.uUID ? entity._aData.uUID : 'new' + ++$scope.newCount;
      $scope.entities[id] = entity._aData;
    }
    $trs = angular.element('tbody tr:not(.processed)');
    $trs.each(function() {
      var $tr;
      $tr = $(this);
      id = $tr.find('td:eq(0)').text();
      if (id) {
        $tr.attr('id', id);
      } else {
        $tr.attr('id', 'new' + $scope.newCount);
      }
      if ($scope.childRows.length) {
        return $(this).find('td:eq(0)').click(function() {
          var child, childRow, data, html, name, row, type, _j, _k, _len1, _len2, _ref1, _ref2;
          row = $scope.dataTables.row($tr);
          if (row.child.isShown()) {
            return row.child.hide();
          } else {
            data = row.data();
            html = '';
            _ref1 = $scope.childRows;
            for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
              childRow = _ref1[_j];
              type = $(childRow).attr('id');
              _ref2 = $scope.childRows.children();
              for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
                child = _ref2[_k];
                name = $(child).data('name');
                html += '<label>' + $(child).text() + ' <input name="' + name + '" value="' + data[type][name] + '"></label>';
              }
            }
            return row.child(html).show();
          }
        });
      }
    });
    $trs.children().each(function() {
      var $input, $th, name;
      $th = $scope.ths.eq($(this).index());
      if ($th.length) {
        name = $th.data('name');
        $input = $('<' + $th.data('input') + '/>').attr({
          name: name
        }).val($(this).text());
        $input.change(function() {
          var $checkbox, uUID;
          uUID = $(this).closest('tr').attr('id');
          $checkbox = $(this).closest('tr').find(':checkbox:eq(0)');
          if ($(this).attr('name') !== 'uUID') {
            $scope.entities[uUID][name] = $(this).val();
            $checkbox.prop('checked', true);
            $(this).closest('td').addClass('dirty');
          }
          return $scope.updated[uUID] = $checkbox.prop('checked');
        });
        return $(this).html($input);
      }
    });
    return $trs.addClass('processed');
  });
  $scope.dtColumns = [];
  $scope.ths.each(function(index, th) {
    return $scope.dtColumns.push(DTColumnBuilder.newColumn($(th).data('name')).withTitle($(th).text()));
  });
  $scope.$on('event:dataTableLoaded', function(event, loadedDT) {
    return $scope.dataTables = loadedDT.dt;
  });
  $scope["new"] = function($event) {
    var data;
    $event.preventDefault();
    data = {};
    $scope.ths.each(function(index, th) {
      return data[$(th).data('name')] = null;
    });
    return $scope.dataTables.row.add(data).draw();
  };
  return $scope.update = function() {
    var id, newEntities, updatedEntities, value, _ref;
    updatedEntities = {};
    newEntities = {};
    _ref = $scope.updated;
    for (id in _ref) {
      value = _ref[id];
      if (value) {
        if (id.substr(0, 3) === 'new') {
          newEntities[id] = $scope.entities[id];
        } else {
          updatedEntities[id] = $scope.entities[id];
        }
      }
    }
    updatedEntities.__csrfToken = $('#__csrfToken').val();
    newEntities.__csrfToken = updatedEntities.__csrfToken;
    if (updatedEntities || newEntities) {
      return $http.post('subugoe.germaniasacra/' + entityName + '/listupdate', updatedEntities).error(function(data) {
        return $scope.message = 'ERROR';
      }).success(function(data) {
        if (newEntities) {
          return $http.post('subugoe.germaniasacra/' + entityName + '/listcreate', newEntities).error(function(data) {
            return $scope.message = 'ERROR';
          }).success(function(data) {
            return $scope.message = 'Änderungen gespeichert.';
          });
        } else {
          return $scope.message = 'Änderungen gespeichert.';
        }
      });
    }
  };
});
